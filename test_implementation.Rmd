---
title: Test implementation of fullGP, NNGP, SGV in nimble
author: Mark Risser
date: 13 February 2019
output: html_document
---

\   

```{r, message = FALSE, warning = FALSE}
library(nimble)
library(coda)
library(StatMatch)
nimbleOptions(verbose = TRUE)
source("../BayesNSGP/BayesNSGP/R/core.R")
source("../BayesNSGP/BayesNSGP/R/NNGP.R")
source("../BayesNSGP/BayesNSGP/R/SGV.R")

```

\   

### Data

We'll use some simulated data for now:

```{r}
# Stationary/isotropic
N <- 100
k <- 15
set.seed(12)
locs <- matrix(runif(2*N), ncol = 2)
alpha_vec <- rep(log(sqrt(1)), N) # Log process SD
delta_vec <- rep(log(sqrt(0.05)), N) # Log nugget SD
Sigma11_vec <- rep(0.4, N) # Kernel matrix element 1,1
Sigma22_vec <- rep(0.4, N) # Kernel matrix element 2,2
Sigma12_vec <- rep(0, N) # Kernel matrix element 1,2
mu_vec <- rep(0, N) # Mean
nu <- 0.5 # Smoothness
dist_list <- nsDist(locs)

Cor_mat <- nsCorr( dist1_sq = dist_list$dist1_sq, dist2_sq = dist_list$dist2_sq, 
        dist12 = dist_list$dist12, Sigma11 = Sigma11_vec, 
        Sigma22 = Sigma22_vec, Sigma12 = Sigma12_vec, nu = nu )
Cov_mat <- diag(exp(alpha_vec)) %*% Cor_mat %*% diag(exp(alpha_vec))
D_mat <- diag(exp(delta_vec)^2) 
set.seed(110)
z <- as.numeric(mu_vec + t(chol(Cov_mat + D_mat)) %*% rnorm(N))
```

Now, set up the constants list for each likelihood:

```{r }
# FullGP 
dist_fullGP <- nsDist(locs)
constants_fullGP <- list( dist1_sq = dist_fullGP$dist1_sq, dist2_sq = dist_fullGP$dist2_sq, 
                          dist12 = dist_fullGP$dist12, nu = 0.5, N = N )

# NNGP
nID_NNGP <- determineNeighbors(locs, k)
dist_NNGP <- nsDist3d(locs, nID_NNGP)
constants_NNGP <- list( dist1_3d = dist_NNGP$dist1_3d, dist2_3d = dist_NNGP$dist2_3d, 
                        dist12_3d = dist_NNGP$dist12_3d, nu = 0.5, N = N, k = k, nID = nID_NNGP )

# SGV
SGV_setup <- sgvSetup(locs = locs, k = k)
nID_SGV <- SGV_setup$nID_ord
dist_SGV <- nsDist3d(locs[SGV_setup$ord,], nID_SGV)
constants_SGV <- list( dist1_3d = dist_SGV$dist1_3d, dist2_3d = dist_SGV$dist2_3d, 
                       dist12_3d = dist_SGV$dist12_3d, num_NZ = 3*N + k*N - (k*(k+1)/2),
                       nu = 0.5, N = N, k = k, nID = nID_SGV, cond_on_y = SGV_setup$condition_on_y_ord )

niter <- 2000
strt.kp <- 1001
```

\    

### Full GP model

First, we'll use the Full GP likelihood.

```{r }
# Defaults: tau_model = "constant", sigma_model = "constant", Sigma_model = "constant", mu_model = "constant"
Rmodel_fullGP <- nsgpModel( likelihood = "fullGP", constants = constants_fullGP, z = z)

compl_model_fullGP <- compileNimble( Rmodel_fullGP )
conf_model_fullGP <- configureMCMC( Rmodel_fullGP )
# conf_model_fullGP$removeSamplers(c("Sigma_coef1", "Sigma_coef2", "Sigma_coef3", "alpha", "delta"))
# conf_model_fullGP$addSampler(target = c("Sigma_coef1", "Sigma_coef2", "Sigma_coef3", "alpha", "delta"), 
#                              type = "RW_block")
conf_model_fullGP$addMonitors(c("Sigma11[1]", "Sigma22[1]", "Sigma12[1]"))
nim_mcmc_fullGP <- buildMCMC(conf_model_fullGP)
nim_Cmcmc_fullGP <- compileNimble(nim_mcmc_fullGP, project = Rmodel_fullGP)
calculate(Rmodel_fullGP, paste("z[1:", N, "]", sep = ""))

prt <- proc.time()
nim_Cmcmc_fullGP$run(niter)
fullGP.tm <- proc.time() - prt
postSamp_fullGP <- as.matrix(nim_Cmcmc_fullGP$mvSamples)[strt.kp:niter,]

# system.time(samples <- nimbleMCMC(model = Rmodel, niter = niter, progressBar = FALSE, setSeed = TRUE))
samplesList <- list(fullGP = postSamp_fullGP[,c("beta","alpha","delta","Sigma11[1]", "Sigma12[1]", "Sigma22[2]")])
```

\   

### NNGP

Next, we'll use the NNGP likelihood approximation, using $k=15$ nearest neighbors.

```{r }
# Defaults: tau_model = "constant", sigma_model = "constant", Sigma_model = "constant", mu_model = "constant"
Rmodel_NNGP <- nsgpModel( likelihood = "NNGP", constants = constants_NNGP, z = z )

compl_model_NNGP <- compileNimble( Rmodel_NNGP )
conf_model_NNGP <- configureMCMC( Rmodel_NNGP )
# conf_model_NNGP$removeSamplers(c("Sigma_coef1", "Sigma_coef2", "Sigma_coef3", "alpha", "delta"))
# conf_model_NNGP$addSampler(target = c("Sigma_coef1", "Sigma_coef2", "Sigma_coef3", "alpha", "delta"),
#                            type = "RW_block")
conf_model_NNGP$addMonitors(c("Sigma11[1]", "Sigma22[1]", "Sigma12[1]"))
nim_mcmc_NNGP <- buildMCMC(conf_model_NNGP)
nim_Cmcmc_NNGP <- compileNimble(nim_mcmc_NNGP, project = Rmodel_NNGP)
calculate(Rmodel_NNGP, paste("z[1:", N, "]", sep = ""))

prt <- proc.time()
nim_Cmcmc_NNGP$run(niter)
NNGP.tm <- proc.time() - prt
postSamp_NNGP <- as.matrix(nim_Cmcmc_NNGP$mvSamples)[strt.kp:niter,]

samplesList$NNGP <- postSamp_NNGP[,c("beta","alpha","delta","Sigma11[1]",
                                   "Sigma12[1]", "Sigma22[2]")]
```

### SGV

Finally, we'll use the SGV likelihood approximation, using $k=15$ nearest neighbors.

```{r }
# Defaults: tau_model = "constant", sigma_model = "constant", Sigma_model = "constant", mu_model = "constant"
Rmodel_SGV <- nsgpModel( likelihood = "SGV", constants = constants_SGV, z = z[SGV_setup$ord] )
compl_model_SGV <- compileNimble( Rmodel_SGV )

conf_model_SGV <- configureMCMC( Rmodel_SGV )
# conf_model_SGV$removeSamplers(c("Sigma_coef1", "Sigma_coef2", "Sigma_coef3", "alpha", "delta"))
# conf_model_SGV$addSampler(target = c("Sigma_coef1", "Sigma_coef2", "Sigma_coef3", "alpha", "delta"),
#                           type = "RW_block")
conf_model_SGV$addMonitors(c("Sigma11[1]", "Sigma22[1]", "Sigma12[1]"))
nim_mcmc_SGV <- buildMCMC(conf_model_SGV)
nim_Cmcmc_SGV <- compileNimble(nim_mcmc_SGV, project = Rmodel_SGV)
calculate(Rmodel_SGV, paste("z[1:", N, "]", sep = ""))

prt <- proc.time()
nim_Cmcmc_SGV$run(niter)
SGV.tm <- proc.time() - prt
postSamp_SGV <- as.matrix(nim_Cmcmc_SGV$mvSamples)[strt.kp:niter,]

samplesList$SGV <- postSamp_SGV[,c("beta","alpha","delta","Sigma11[1]",
                                   "Sigma12[1]", "Sigma22[2]")]

```

\   

### Results

Check agreement between the fullGP, NNGP, and SGV likelihoods.

```{r }
# chainsPlot(samplesList)
par(mfrow = c(2,3))
plot(samplesList[[1]][,"Sigma11[1]"], type = "l", 
     main = "black = FullGP, blue = NNGP, green = SGV", 
     ylim = range(c(samplesList[[1]][,"Sigma11[1]"],
                    samplesList[[2]][,"Sigma11[1]"],
                    samplesList[[3]][,"Sigma11[1]"])))
lines(samplesList[[2]][,"Sigma11[1]"], col = 4)
lines(samplesList[[3]][,"Sigma11[1]"], col = 3)
abline(h = Sigma11_vec[1], col = 2)

plot(samplesList[[1]][,"Sigma22[1]"], type = "l", 
     main = "black = FullGP, blue = NNGP, green = SGV", 
     ylim = range(c(samplesList[[1]][,"Sigma22[1]"],
                    samplesList[[2]][,"Sigma22[1]"],
                    samplesList[[3]][,"Sigma22[1]"])))
lines(samplesList[[2]][,"Sigma22[1]"], col = 4)
lines(samplesList[[3]][,"Sigma22[1]"], col = 3)
abline(h = Sigma22_vec[1], col = 2)

plot(samplesList[[1]][,"Sigma12[1]"], type = "l", 
     main = "black = FullGP, blue = NNGP, green = SGV", 
     ylim = range(c(samplesList[[1]][,"Sigma12[1]"],
                    samplesList[[2]][,"Sigma12[1]"],
                    samplesList[[3]][,"Sigma12[1]"])))
lines(samplesList[[2]][,"Sigma12[1]"], col = 4)
lines(samplesList[[3]][,"Sigma12[1]"], col = 3)
abline(h = Sigma12_vec[1], col = 2)

plot(samplesList[[1]][,"beta"], type = "l", 
     main = "black = FullGP, blue = NNGP, green = SGV", 
     ylim = range(c(samplesList[[1]][,"beta"],
                    samplesList[[2]][,"beta"],
                    samplesList[[3]][,"beta"])))
lines(samplesList[[2]][,"beta"], col = 4)
lines(samplesList[[3]][,"beta"], col = 3)
abline(h = mu_vec[1], col = 2)

plot(samplesList[[1]][,"delta"], type = "l", 
     main = "black = FullGP, blue = NNGP, green = SGV", 
     ylim = range(c(samplesList[[1]][,"delta"],
                    samplesList[[2]][,"delta"],
                    samplesList[[3]][,"delta"])))
lines(samplesList[[2]][,"delta"], col = 4)
lines(samplesList[[3]][,"delta"], col = 3)
abline(h = exp(delta_vec[1])^2, col = 2)

plot(samplesList[[1]][,"alpha"], type = "l", 
     main = "black = FullGP, blue = NNGP, green = SGV", 
     ylim = range(c(samplesList[[1]][,"alpha"],
                    samplesList[[2]][,"alpha"],
                    samplesList[[3]][,"alpha"])))
lines(samplesList[[2]][,"alpha"], col = 4)
lines(samplesList[[3]][,"alpha"], col = 3)
abline(h = exp(alpha_vec[1])^2, col = 2)

plot(exp(samplesList[[1]][,"delta"])^2, type = "l", 
     main = "black = FullGP, blue = NNGP, green = SGV", 
     ylim = range(c(exp(samplesList[[1]][,"delta"])^2,
                    exp(samplesList[[2]][,"delta"])^2,
                    exp(samplesList[[3]][,"delta"])^2)))
lines(exp(samplesList[[2]][,"delta"])^2, col = 4)
lines(exp(samplesList[[3]][,"delta"])^2, col = 3)
abline(h = exp(delta_vec[1])^2, col = 2)

plot(exp(samplesList[[1]][,"alpha"])^2, type = "l", 
     main = "black = FullGP, blue = NNGP, green = SGV", 
     ylim = range(c(exp(samplesList[[1]][,"alpha"])^2,
                    exp(samplesList[[2]][,"alpha"])^2,
                    exp(samplesList[[3]][,"alpha"])^2)))
lines(exp(samplesList[[2]][,"alpha"])^2, col = 4)
lines(exp(samplesList[[3]][,"alpha"])^2, col = 3)
abline(h = exp(alpha_vec[1])^2, col = 2)


```

Check effective sample size between the fullGP, NNGP, and SGV likelihoods.

```{r }
# do.call('cbind', lapply(samplesList, function(x) apply(x, 2, effectiveSize)))
```


\   


\   

\   

\   

\    

\    

\   

\   

\   

\   

\    






